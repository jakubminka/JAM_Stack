<!-- SKRIPTY -->
<script
  src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
  integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
  crossorigin="anonymous"
></script>
<script
  src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
  integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
  crossorigin="anonymous"
></script>
<script
  src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
  integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
  crossorigin="anonymous"
></script>

<!-- Skript pro přihlášení do Netlify CMS -->
<script>
  if (window.netlifyIdentity) {
    window.netlifyIdentity.on("init", user => {
      if (!user) {
        window.netlifyIdentity.on("login", () => {
          document.location.href = "/admin/";
        });
      }
    });
  }
</script>

<!-- Skript widgetu pro přihlášení do Netlify CMS -->
<script src="https://identity.netlify.com/v1/netlify-identity-widget.js"></script>

<!-- Vlastní skripty -->
<script>
  function brandOver() {
    document.getElementById("brandChange").style.color = "white";
    document.getElementById("colorBrand").style.color = "#42bcf4";
  }
  function brandOut() {
    document.getElementById("brandChange").style.color = "white";
    document.getElementById("colorBrand").style.color = "";
  }

  function zvetsiText() {
    document.getElementById("brandChange").style.fontSize = "x-large";
  }

  function zmensiText(element) {
    document.getElementById("brandChange").style.fontSize = "";
  }
</script>

<!-- API PouchDB Database -->
<script src="//cdn.jsdelivr.net/npm/pouchdb@7.0.0/dist/pouchdb.min.js"></script>
<script>
  (function() {
    "use strict";

    var model = null;

    var shopper = function(themodel) {
      if (themodel) {
        themodel(function(err, response) {
          if (err) {
            console.error(err);
          } else {
            model = response;
            console.log("Databáze připravena!");
          }
        });
      }
      return this;
    };

    window.shopper = shopper;
  })();
</script>
<script>
  (function() {
    "use strict";

    // PouchDB
    var db = null;

    var model = function(callback) {
      db = new PouchDB("DB");
      if (typeof callback === "function") {
        console.log("model ready!");
        callback(null, model);
      }
    };

    window.addEventListener("DOMContentLoaded", function() {
      window.shopper(model);
    });
  })();
</script>
<script>
  (function() {
    "use strict";

    var model = null;

    // make doc id friendlier for using as DOM node id
    var sanitize = function(id) {
      return id.replace(/[:.]/gi, "-");
    };

    // add docs to DOM node list
    var addToList = function(docs) {
      for (var i = 0; i < docs.length; i++) {
        var doc = docs[i];

        var isList = doc.type === "list" || doc._id.indexOf("list:") === 0;
        var shoppinglists = null;

        if (isList) {
          shoppinglists = document.getElementById("shopping-lists");
        } else {
          continue;
        }

        doc._sanitizedid = sanitize(doc._id);

        var template = document.getElementById("shopping-list-template")
          .innerHTML;
        template = template.replace(/\{\{(.+?)\}\}/g, function($0, $1) {
          var fields = $1.split(".");
          var value = doc;
          while (fields.length) {
            if (value.hasOwnProperty(fields[0])) {
              value = value[fields.shift()];
            } else {
              value = null;
              break;
            }
          }
          return value || "";
        });

        var listdiv = document.createElement("div");
        listdiv.id = doc._sanitizedid;
        listdiv.className = "card collapsible";
        listdiv.innerHTML = template;

        var existingdiv = document.getElementById(doc._sanitizedid);
        if (existingdiv) {
          shoppinglists.replaceChild(listdiv, existingdiv);
        } else {
          shoppinglists.insertBefore(listdiv, shoppinglists.firstChild);
        }
      }
    };

    var shopper = function(themodel) {
      if (themodel) {
        themodel(function(err, response) {
          if (err) {
            console.error(err);
          } else {
            model = response;
            model.lists(function(err, docs) {
              if (err) {
                console.error(err);
              } else {
                addToList(docs, true);
              }
              console.log("shopper ready!");
            });
          }
        });
      }
      return this;
    };

    shopper.openadd = function() {
      var form = document.getElementById("shopping-list-add");
      form.reset();
      document.body.className += " " + form.id;
    };

    shopper.closeadd = function() {
      document.body.className = document.body.className
        .replace("shopping-list-add", "")
        .trim();
    };

    shopper.add = function(event) {
      var form = event.target;
      var elements = form.elements;
      var doc = {};

      if (!elements["title"].value) {
        console.error("title required");
      } else {
        for (var i = 0; i < elements.length; i++) {
          if (elements[i].tagName.toLowerCase() !== "button") {
            doc[elements[i].name] = elements[i].value;
          }
        }

        model.save(doc, function(err, updated) {
          if (err) {
            console.error(err);
          } else {
            doc._id = doc._id || updated._id || updated.id;
            addToList([doc]);
            shopper.closeadd();
          }
        });
      }
    };

    window.shopper = shopper;
  })();
</script>
<script>
  (function() {
    "use strict";

    // PouchDB
    var db = null;

    // Shopping List Schema
    // https://github.com/ibm-watson-data-lab/shopping-list#shopping-list-example
    var initListDoc = function(doc) {
      return {
        _id: "list:" + new Date().toISOString(),
        type: "list",
        version: 1,
        title: doc.title,
        checked: !!doc.checked,
        place: {
          title: doc.place ? doc.place.title : "",
          license: doc.place ? doc.place.license : "",
          lat: doc.place ? doc.place.lat : null,
          lon: doc.place ? doc.place.lon : null,
          address: doc.place ? doc.place.address : {}
        },
        createdAt: new Date().toISOString(),
        updatedAt: ""
      };
    };

    var model = function(callback) {
      db = new PouchDB("shopping");

      db.info(function(err, info) {
        if (err) {
          console.error(err);
        } else {
          console.log("model.info", info);
        }
      });

      db.createIndex(
        {
          index: { fields: ["type"] }
        },
        function(err, response) {
          if (typeof callback === "function") {
            console.log("model ready!");
            callback(err, model);
          }
        }
      );
    };

    model.lists = function(callback) {
      db.find(
        {
          selector: {
            type: "list"
          }
        },
        function(err, response) {
          if (typeof callback === "function") {
            var docs = response ? response.docs || response : response;
            callback(err, docs);
          }
        }
      );
    };

    model.save = function(d, callback) {
      var doc = null;

      if (d.type === "list") {
        doc = initListDoc(d);
      }

      if (doc) {
        db.put(doc, function(err, response) {
          if (typeof callback === "function") {
            callback(err, response);
          }
        });
      } else {
        if (typeof callback === "function") {
          callback(new Error("Missing or unsupport doc type"), null);
        }
      }
    };

    window.addEventListener("DOMContentLoaded", function() {
      window.shopper(model);
    });
  })();
</script>
<script src="https://cdn.jsdelivr.net/npm/pouchdb@6.3.4/dist/pouchdb.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/pouchdb@6.3.4/dist/pouchdb.find.min.js"></script>
<script>
  // remove from DOM node list
  var removeFromList = function(id) {
    var list = document.getElementById(sanitize(id));
    shopper.toggle(list);
    list.parentElement.removeChild(list);
  };
</script>
